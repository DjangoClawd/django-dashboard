<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Prices ü§†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
    }
    .card {
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      transition: all 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      border-color: rgba(255,255,255,0.2);
    }
    .positive { color: #10b981; }
    .negative { color: #ef4444; }
  </style>
</head>
<body class="text-gray-100 p-6">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8">
      <div>
        <h1 class="text-3xl font-bold">üìä Crypto Prices</h1>
        <p class="text-gray-400 mt-1">Live from Dexscreener</p>
      </div>
      <div class="flex gap-3">
        <a href="index.html" class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg font-medium transition">
          ‚Üê Tasks
        </a>
        <button onclick="refreshPrices()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition">
          ‚Üª Refresh
        </button>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-6">
      <div class="flex gap-3">
        <input type="text" id="search-input" placeholder="Search token (e.g., SOL, BONK, WIF)..." 
               class="flex-1 px-4 py-3 bg-gray-800 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
               onkeypress="if(event.key==='Enter')searchToken()">
        <button onclick="searchToken()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 rounded-lg font-medium transition">
          Search
        </button>
      </div>
    </div>

    <!-- Watchlist -->
    <div class="mb-8">
      <h2 class="text-xl font-bold mb-4">‚≠ê Watchlist</h2>
      <div id="watchlist" class="grid gap-4">
        <div class="card rounded-xl p-4 text-center text-gray-500">Loading...</div>
      </div>
    </div>

    <!-- Search Results -->
    <div id="search-results-container" class="hidden mb-8">
      <h2 class="text-xl font-bold mb-4">üîç Search Results</h2>
      <div id="search-results" class="grid gap-4"></div>
    </div>

    <!-- Footer -->
    <div class="mt-8 text-center text-gray-500 text-sm">
      Data from <a href="https://dexscreener.com" class="text-blue-400 hover:underline">Dexscreener</a> ‚Ä¢ 
      Last updated: <span id="last-updated">-</span>
    </div>
  </div>

  <script>
    // Default watchlist - popular Solana tokens
    const defaultWatchlist = [
      { symbol: 'SOL', address: 'So11111111111111111111111111111111111111112', chain: 'solana' },
      { symbol: 'BONK', address: 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263', chain: 'solana' },
      { symbol: 'WIF', address: 'EKpQGSJtjMFqKZ9KQanSqYXRcF8fBopzLHYxdM65zcjm', chain: 'solana' },
      { symbol: 'POPCAT', address: '7GCihgDB8fe6KNjn2MYtkzZcRjQy3t9GHdC8uHYmW2hr', chain: 'solana' },
    ];

    async function fetchTokenPrice(address, chain = 'solana') {
      try {
        const response = await fetch(`https://api.dexscreener.com/latest/dex/tokens/${address}`);
        const data = await response.json();
        if (data.pairs && data.pairs.length > 0) {
          // Get the pair with highest liquidity
          const pair = data.pairs.sort((a, b) => (b.liquidity?.usd || 0) - (a.liquidity?.usd || 0))[0];
          return {
            symbol: pair.baseToken.symbol,
            name: pair.baseToken.name,
            price: parseFloat(pair.priceUsd) || 0,
            change24h: parseFloat(pair.priceChange?.h24) || 0,
            volume24h: pair.volume?.h24 || 0,
            liquidity: pair.liquidity?.usd || 0,
            dexId: pair.dexId,
            pairAddress: pair.pairAddress,
            url: pair.url
          };
        }
        return null;
      } catch (e) {
        console.error('Failed to fetch token:', e);
        return null;
      }
    }

    async function searchToken() {
      const query = document.getElementById('search-input').value.trim();
      if (!query) return;

      const resultsContainer = document.getElementById('search-results-container');
      const results = document.getElementById('search-results');
      resultsContainer.classList.remove('hidden');
      results.innerHTML = '<div class="card rounded-xl p-4 text-center text-gray-500">Searching...</div>';

      try {
        const response = await fetch(`https://api.dexscreener.com/latest/dex/search?q=${encodeURIComponent(query)}`);
        const data = await response.json();
        
        if (data.pairs && data.pairs.length > 0) {
          // Dedupe by base token and sort by liquidity
          const seen = new Set();
          const tokens = data.pairs
            .filter(p => {
              const key = p.baseToken.address;
              if (seen.has(key)) return false;
              seen.add(key);
              return true;
            })
            .sort((a, b) => (b.liquidity?.usd || 0) - (a.liquidity?.usd || 0))
            .slice(0, 10);

          results.innerHTML = tokens.map(pair => renderToken({
            symbol: pair.baseToken.symbol,
            name: pair.baseToken.name,
            price: parseFloat(pair.priceUsd) || 0,
            change24h: parseFloat(pair.priceChange?.h24) || 0,
            volume24h: pair.volume?.h24 || 0,
            liquidity: pair.liquidity?.usd || 0,
            dexId: pair.dexId,
            chain: pair.chainId,
            url: pair.url
          })).join('');
        } else {
          results.innerHTML = '<div class="card rounded-xl p-4 text-center text-gray-500">No results found</div>';
        }
      } catch (e) {
        results.innerHTML = '<div class="card rounded-xl p-4 text-center text-red-400">Search failed</div>';
      }
    }

    function renderToken(token) {
      const changeClass = token.change24h >= 0 ? 'positive' : 'negative';
      const changeSign = token.change24h >= 0 ? '+' : '';
      const priceStr = token.price < 0.01 ? token.price.toFixed(8) : token.price.toFixed(4);
      const volumeStr = formatNumber(token.volume24h);
      const liqStr = formatNumber(token.liquidity);

      return `
        <div class="card rounded-xl p-4">
          <div class="flex items-center justify-between">
            <div>
              <div class="flex items-center gap-2">
                <span class="font-bold text-lg">${token.symbol}</span>
                <span class="text-gray-500 text-sm">${token.name || ''}</span>
                ${token.chain ? `<span class="text-xs px-2 py-0.5 bg-gray-700 rounded">${token.chain}</span>` : ''}
              </div>
              <div class="text-gray-400 text-sm mt-1">
                Vol: $${volumeStr} ‚Ä¢ Liq: $${liqStr}
              </div>
            </div>
            <div class="text-right">
              <div class="text-xl font-mono">$${priceStr}</div>
              <div class="${changeClass} text-sm">${changeSign}${token.change24h.toFixed(2)}%</div>
            </div>
          </div>
          ${token.url ? `<a href="${token.url}" target="_blank" class="text-blue-400 text-sm hover:underline mt-2 inline-block">View on Dexscreener ‚Üí</a>` : ''}
        </div>
      `;
    }

    function formatNumber(num) {
      if (!num) return '0';
      if (num >= 1e9) return (num / 1e9).toFixed(2) + 'B';
      if (num >= 1e6) return (num / 1e6).toFixed(2) + 'M';
      if (num >= 1e3) return (num / 1e3).toFixed(2) + 'K';
      return num.toFixed(2);
    }

    async function refreshPrices() {
      const watchlist = document.getElementById('watchlist');
      watchlist.innerHTML = '<div class="card rounded-xl p-4 text-center text-gray-500">Loading...</div>';

      const tokens = await Promise.all(
        defaultWatchlist.map(t => fetchTokenPrice(t.address, t.chain))
      );

      const validTokens = tokens.filter(t => t !== null);
      
      if (validTokens.length > 0) {
        watchlist.innerHTML = validTokens.map(renderToken).join('');
      } else {
        watchlist.innerHTML = '<div class="card rounded-xl p-4 text-center text-gray-500">Failed to load prices</div>';
      }

      document.getElementById('last-updated').textContent = new Date().toLocaleString();
    }

    // Load on start
    refreshPrices();
  </script>
</body>
</html>
